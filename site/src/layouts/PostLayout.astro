---
import { Image } from "astro:assets";
import { getPostHeroImage } from "../lib/postImages";

// ✅ Restore props destructuring (was removed, causing `heroImage is not defined`)
const {
  title,
  description,
  publishedAt,

  // ✅ Back-compat: old single category
  category,

  // ✅ New: multi category support
  categories,

  audience,
  heroImage,
  heroAlt,
  imageCreditName,
  imageCreditUrl,
  readingTime,
  toc = [],
} = Astro.props;

// Detect whether heroImage is a public URL (/images/...) or an asset path
const isPublicHero = typeof heroImage === "string" && heroImage.startsWith("/");

// Only resolve asset images via astro:assets
const heroAsset = !isPublicHero && heroImage ? getPostHeroImage(heroImage) : null;

const safeHeroAlt = heroAlt ?? title;

const dateLabel =
  publishedAt instanceof Date
    ? publishedAt.toLocaleDateString("en-GB", {
        year: "numeric",
        month: "long",
        day: "numeric",
      })
    : publishedAt
      ? String(publishedAt)
      : "—";

// On Vercel, don't fs.existsSync() the public directory at runtime.
// Render the URL and rely on browser onerror fallback.
const resolvedHeroImage = isPublicHero
  ? (typeof heroImage === "string" && heroImage ? heroImage : "/images/placeholder-hero.webp")
  : null;

const showHero = Boolean((isPublicHero && resolvedHeroImage) || heroAsset);
const showToc = Array.isArray(toc) && toc.length > 0;

/**
 * Category normalization:
 * - Prefer categories[] (multi)
 * - Fall back to legacy category (single)
 * - Normalize values to lowercase IDs (safe for routing)
 */
function normalizeCategoryId(x) {
  return String(x || "").trim().toLowerCase();
}

function humanizeCategory(id) {
  // Simple default label (taxonomy-driven labels can replace this later)
  return String(id || "")
    .replaceAll("_", " ")
    .replaceAll("-", " ")
    .trim()
    .replace(/\b\w/g, (c) => c.toUpperCase());
}

const categoryIdsRaw = Array.isArray(categories) ? categories : category ? [category] : [];
const categoryIds = categoryIdsRaw
  .map(normalizeCategoryId)
  .filter(Boolean);

// De-dupe while preserving order
const seen = new Set();
const categoriesUnique = categoryIds.filter((c) => {
  if (seen.has(c)) return false;
  seen.add(c);
  return true;
});
---

<section class="post-shell">
  <header class="post-header">
    {showHero && (
      <figure class="hero">
        <div class="hero-frame">
          {isPublicHero ? (
            <img
              src={resolvedHeroImage ?? "/images/placeholder-hero.webp"}
              alt={safeHeroAlt}
              width="1600"
              height="900"
              loading="eager"
              decoding="async"
              class="hero-img"
              onerror="this.onerror=null;this.src='/images/placeholder-hero.webp';"
            />
          ) : (
            <Image
              src={heroAsset}
              alt={safeHeroAlt}
              width={heroAsset.width}
              height={heroAsset.height}
              class="hero-img"
              sizes="(min-width: 1024px) 960px, 100vw"
              loading="eager"
              decoding="async"
            />
          )}
        </div>  

        {(imageCreditName || imageCreditUrl) && (
          <figcaption class="hero-credit">
            Image credit:{" "}
            {imageCreditUrl ? (
              <a href={imageCreditUrl} class="hero-credit-link">
                {imageCreditName ?? "Source"}
              </a>
            ) : (
              <span>{imageCreditName}</span>
            )}
          </figcaption>
        )}
      </figure>
    )}

    <div class="post-meta">
      <span class="post-date">{dateLabel}</span>

      {categoriesUnique.length > 0 ? <span class="post-dot">•</span> : null}

      {categoriesUnique.length > 0 ? (
        <span class="post-cats">
          {categoriesUnique.map((c, idx) => (
            <>
              <a class="post-cat" href={`/category/${c}`}>
                {humanizeCategory(c)}
              </a>
              {idx < categoriesUnique.length - 1 ? (
                <span class="post-cat-sep">,</span>
              ) : null}
            </>
          ))}
        </span>
      ) : null}

      {readingTime ? <span class="post-dot">•</span> : null}
      {readingTime ? <span class="post-rt">{readingTime} min read</span> : null}
    </div>

    <h1 class="post-title">{title}</h1>

    {description ? <p class="post-desc">{description}</p> : null}

    <div class="post-chips">
      {audience ? (
        <span class="chip chip-audience">Audience: {audience}</span>
      ) : null}

      {/* ✅ Category chips (multi) */}
      {categoriesUnique.map((c) => (
        <a class="chip chip-cat" href={`/category/${c}`}>
          {humanizeCategory(c)}
        </a>
      ))}

      <span class="chip">Curated picks</span>
      <span class="chip">Skimmable + practical</span>

      <a class="chip chip-jump" href="#the-picks">Jump to picks</a>
    </div>
  </header>

  <div class="post-grid">
    <main class="post-main">
      <div class="post-article">
        <div class="prose-premium">
          <!-- All article + pick rendering happens in the page -->
          <slot />
        </div>
      </div>

      <div class="post-disclosure" id="affiliate-disclosure">
        <p class="disc-title">Affiliate disclosure</p>
        <p class="disc-body">
          Some links may be affiliate links. If you buy through them, we may earn a
          commission at no extra cost to you. We only include items that meet our
          quality thresholds.
        </p>
      </div>
    </main>

    <aside class="post-aside">
      <slot name="sidebar">
        <div class="sidecard">
          <div class="sidehead">On this page</div>

          {showToc ? (
            <nav class="toc">
              <ol class="toc-list">
                {toc.map((item) => (
                  <li class="toc-item">
                    <a class="toc-link" href={`#${item.id}`}>
                      {item.text}
                    </a>
                  </li>
                ))}
              </ol>
            </nav>
          ) : (
            <p class="toc-empty">No table of contents is available for this page.</p>
          )}

          <div class="side-actions">
            <a href="#the-picks" class="side-btn">Jump to picks</a>
            <p class="side-tip">
              Tip: skim the picks first, then circle back to “How this list was chosen”
              if you want the logic behind the list.
            </p>
          </div>
        </div>
      </slot>
    </aside>
  </div>
</section>

<style>
  .post-shell {
    max-width: 1120px;
    margin: 0 auto;
    padding: 28px 24px 64px;
  }

  .post-header {
    background: #fff;
    border: 1px solid rgba(17, 24, 39, 0.08);
    border-radius: 18px;
    padding: 26px;
    box-shadow: 0 1px 0 rgba(17, 24, 39, 0.03);
  }

  .post-meta {
    margin-top: 14px;
    font-size: 12px;
    color: rgba(55, 65, 81, 0.85);
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }

  .post-dot {
    opacity: 0.55;
  }

  .post-cats {
    display: inline-flex;
    flex-wrap: wrap;
    gap: 4px;
    align-items: baseline;
  }

  .post-cat {
    color: rgba(17, 24, 39, 0.82);
    text-decoration: none;
    font-weight: 750;
  }

  .post-cat:hover {
    color: rgb(37, 99, 235);
    text-decoration: underline;
    text-underline-offset: 3px;
  }

  .post-cat-sep {
    opacity: 0.55;
    margin-right: 4px;
  }

  .post-title {
    margin-top: 10px;
    font-size: clamp(30px, 3.4vw, 52px);
    line-height: 1.06;
    letter-spacing: -0.02em;
    font-weight: 650;
  }

  .post-desc {
    margin-top: 12px;
    font-size: 17px;
    line-height: 1.55;
    max-width: 70ch;
  }

  /* ✅ Pills / chips */
  .post-chips {
    margin-top: 14px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  .chip {
    display: inline-flex;
    align-items: center;
    font-size: 13px;
    font-weight: 650;
    padding: 7px 12px;
    border-radius: 999px;
    border: 1px solid rgba(17, 24, 39, 0.12);
    background: rgba(17, 24, 39, 0.03);
    color: rgba(17, 24, 39, 0.82);
    max-width: 100%;
    text-decoration: none;
  }

  .chip:hover {
    border-color: rgba(37, 99, 235, 0.28);
  }

  .chip-audience {
    border-color: rgba(37, 99, 235, 0.22);
    background: rgba(37, 99, 235, 0.06);
    color: rgba(17, 24, 39, 0.88);
  }

  .chip-cat {
    border-color: rgba(17, 24, 39, 0.12);
    background: rgba(17, 24, 39, 0.02);
  }

  .chip-jump {
    border-color: rgba(37, 99, 235, 0.22);
    background: rgba(37, 99, 235, 0.06);
    color: rgba(29, 78, 216, 0.95);
  }

  /* Hide the extra jump chip on desktop where sidebar already provides it */
  @media (min-width: 1024px) {
    .chip-jump {
      display: none;
    }
  }

  .post-grid {
    margin-top: 18px;
    display: grid;
    grid-template-columns: 1fr;
    gap: 18px;
  }

  @media (min-width: 1024px) {
    .post-grid {
      grid-template-columns: minmax(0, 1fr) 340px;
    }
  }

  .post-article {
    background: #fff;
    border: 1px solid rgba(17, 24, 39, 0.08);
    border-radius: 18px;
    padding: 26px;
  }

  .prose-premium {
    max-width: none;
    font-size: 16.5px;
    line-height: 1.72;
  }

  .prose-premium :global(.prose > :first-child) {
    margin-top: 0;
  }

  .prose-premium :global(.prose h2) {
    margin: 20px 0 10px;
    font-size: 22px;
    font-weight: 900;
    letter-spacing: -0.02em;
    color: rgba(17, 24, 39, 0.95);
  }

  .prose-premium :global(.prose h3) {
    margin: 18px 0 8px;
    font-size: 18px;
    font-weight: 850;
    letter-spacing: -0.01em;
    color: rgba(17, 24, 39, 0.95);
  }

  /* ✅ Hero */
  .hero {
    margin-top: 0;
  }

  .hero-frame {
    border-radius: 16px;
    overflow: hidden;
    border: 1px solid rgba(17, 24, 39, 0.10);
    background: rgba(17, 24, 39, 0.02);

    width: 100%;
    aspect-ratio: 16 / 9;         /* ✅ match generated hero images */
    max-height: 420px;             /* ✅ keeps it from getting too tall on huge screens */

    display: flex;
    align-items: center;
    justify-content: center;
  }

  @media (max-width: 768px) {
    .hero-frame {
      height: clamp(200px, 56.25vw, 320px); /* ✅ 16:9-based height on mobile */
    }
  }

  .hero-img {
    width: 100%;
    height: 100%;
    /*
      Fill the hero frame.
      Our hero images are generated at 16:9, matching the frame.
      If an older/legacy image has a different ratio, it may crop slightly.
    */
    object-fit: cover;
    object-position: center;
    display: block;
  }

  .hero-credit {
    margin-top: 8px;
    font-size: 12px;
    color: rgba(55, 65, 81, 0.75);
  }

  .hero-credit-link {
    text-decoration: underline;
    text-underline-offset: 3px;
    color: inherit;
  }

  .hero-credit-link:hover {
    color: rgba(17, 24, 39, 0.9);
  }
</style>
