---
import SiteLayout from "../../layouts/SiteLayout.astro";
import TopTopicsNav from "../../components/TopTopicsNav.astro";
import GuideCard from "../../components/GuideCard.astro";
import { getCollection } from "astro:content";
import { getTaxonomy } from "../../lib/taxonomy";
import { normalizePostCategories } from "../../lib/normalizeCategories"; // <-- remove primaryCategory
import { getPostCardDescription } from "../../lib/postExcerpt";
import {
  buildBreadcrumbList,
  buildCollectionPageJsonLd,
  toAbsoluteUrl,
} from "../../lib/structuredData";

const taxonomy = await getTaxonomy();
const posts = await getCollection("posts");

// Newest first (stable)
posts.sort((a, b) => {
  const t = b.data.publishedAt.getTime() - a.data.publishedAt.getTime();
  if (t !== 0) return t;
  return b.slug.localeCompare(a.slug);
});

// Build safe group category sets once
const groupCategorySets = new Map<string, Set<string>>();

for (const g of taxonomy.groups ?? []) {
  const raw = (g?.categoryIds ?? g?.categories ?? []) as unknown[];

  const ids = raw
    .map((c) => String(c ?? "").trim().toLowerCase())
    .filter(Boolean);

  groupCategorySets.set(String(g.key), new Set(ids));
}

// Count posts per group (a post counts if ANY of its categories is in the group)
const countsByGroup: Record<string, number> = {};

for (const g of taxonomy.groups ?? []) {
  const key = String(g.key);
  const set = groupCategorySets.get(key) ?? new Set<string>();

  countsByGroup[key] = posts.filter((post) => {
    const cats = normalizePostCategories(post, taxonomy);
    return cats.some((c) => set.has(c));
  }).length;
}

const navItems = [
  { key: "all", label: "All", count: posts.length, href: "/posts" },
  ...(taxonomy.groups ?? [])
    .map((g: any) => ({
      key: String(g.key),
      label: String(g.label ?? g.key),
      count: countsByGroup[String(g.key)] ?? 0,
      href: `/posts/${String(g.key)}`,
    }))
    .filter((it) => (typeof it.count === "number" ? it.count > 0 : true)),
];

const baseUrl = (Astro.site ?? "http://localhost").toString();
const canonicalPath = "/posts";
const canonicalUrl = toAbsoluteUrl(baseUrl, canonicalPath);

const breadcrumbJsonLd = buildBreadcrumbList([
  { name: taxonomy.brand.name, url: toAbsoluteUrl(baseUrl, "/") },
  { name: "Guides", url: canonicalUrl },
]);

const listJsonLd = buildCollectionPageJsonLd({
  canonicalUrl,
  name: "All guides",
  description: taxonomy?.homepage?.seoDescription ?? taxonomy?.brand?.tagline ?? "",
  itemList: posts.map((p) => ({
    name: String(p.data.title),
    url: toAbsoluteUrl(baseUrl, `/posts/${p.slug}`),
  })),
});
---

<SiteLayout
  title="All guides"
  description={taxonomy?.homepage?.seoDescription ?? taxonomy?.brand?.tagline ?? ""}
  canonical="/posts"
>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbJsonLd)} />
    <script type="application/ld+json" set:html={JSON.stringify(listJsonLd)} />
  </Fragment>

  <div class="max-w-6xl mx-auto px-6 pt-12">
    <TopTopicsNav items={navItems} active="all" />

    <header class="mt-10">
      <h1 class="text-3xl font-semibold tracking-tight text-gray-900 sm:text-4xl">
        All guides
      </h1>
      <p class="mt-3 text-base text-gray-600">Curated picks, updated regularly.</p>
    </header>

    <div class="mt-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <div class="w-full sm:max-w-md">
        <label for="guide-search" class="sr-only">Search guides</label>
        <input
          id="guide-search"
          type="search"
          inputmode="search"
          autocomplete="off"
          placeholder="Search guides…"
          class="w-full rounded-2xl border border-gray-200 bg-white px-4 py-3 text-sm text-gray-900 shadow-sm outline-none focus:border-blue-300 focus:ring-2 focus:ring-blue-100"
        />
      </div>

      <a
        id="guide-clear"
        href="/posts"
        class="inline-flex w-fit items-center justify-center rounded-2xl border border-gray-200 bg-white px-4 py-3 text-sm font-semibold text-gray-900 hover:bg-gray-50"
      >
        Clear filters
      </a>
    </div>

    <p id="guide-status" class="mt-3 text-sm text-gray-600" aria-live="polite"></p>

    {posts.length ? (
      <section id="guides-grid" class="mt-8 grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
        {posts.map((post) => {
          const cats = normalizePostCategories(post, taxonomy);
          const cardDescription = getPostCardDescription(post);
          const haystack = [
            post.data.title,
            cardDescription,
            cats.join(" "),
          ]
            .filter(Boolean)
            .join(" ")
            .toLowerCase();

          return (
            <div
              data-guide
              data-search={haystack}
              data-cats={cats.join(",")}
            >
              <GuideCard post={post} taxonomy={taxonomy} />
            </div>
          );
        })}
      </section>
    ) : (
      <div class="mt-10 rounded-3xl border border-dashed border-gray-300 bg-white p-12">
        <h2 class="text-xl font-semibold text-gray-900">No guides yet</h2>
        <p class="mt-3 text-sm text-gray-600">
          Add a post in{" "}
          <code class="rounded bg-gray-100 px-1.5 py-0.5">site/src/content/posts</code>.
        </p>
      </div>
    )}
  </div>
</SiteLayout>

<script>
  (() => {
    const input = document.getElementById("guide-search");
    const status = document.getElementById("guide-status");
    const clearLink = document.getElementById("guide-clear");
    const cards = Array.from(document.querySelectorAll("[data-guide]"));

    if (!(input instanceof HTMLInputElement) || !status || !clearLink) return;

    const params = new URLSearchParams(window.location.search);
    const category = (params.get("category") || "").trim().toLowerCase();
    const q0 = (params.get("q") || "").trim();

    if (q0) input.value = q0;

    if (category) {
      clearLink.textContent = `Clear “${category}” filter`;
    }

    function apply() {
      const q = input.value.trim().toLowerCase();
      let shown = 0;

      for (const el of cards) {
        const hay = (el.getAttribute("data-search") || "").toLowerCase();
        const cats = (el.getAttribute("data-cats") || "")
          .split(",")
          .map((s) => s.trim().toLowerCase())
          .filter(Boolean);

        const okQ = !q || hay.includes(q);
        const okCat = !category || cats.includes(category);
        const show = okQ && okCat;

        el.style.display = show ? "" : "none";
        if (show) shown++;
      }

      const parts = [];
      if (category) parts.push(`Category: ${category}`);
      if (q) parts.push(`Search: “${q}”`);

      status.textContent = parts.length
        ? `${shown} guide(s) shown. ${parts.join(" · ")}`
        : `${shown} guide(s) shown.`;
    }

    input.addEventListener("input", apply);
    apply();
  })();
</script>