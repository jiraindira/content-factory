---
import { getCollection } from "astro:content";
import SiteLayout from "../../layouts/SiteLayout.astro";
import PostLayout from "../../layouts/PostLayout.astro";
import ProductListItem from "../../components/ProductListItem.astro";
import { getPostHeroImage } from "../../lib/postImages";

export async function getStaticPaths() {
  const posts = await getCollection("posts");
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

const { products = [], category, publishedAt } = post.data;

const FALLBACK_HERO = "/images/placeholder-hero.webp";

function formatDate(d) {
  try {
    return new Date(d).toLocaleDateString("en-GB", {
      day: "2-digit",
      month: "long",
      year: "numeric",
    });
  } catch {
    return "";
  }
}

function prettyCategory(s) {
  if (!s) return "";
  return s
    .replace(/_/g, " ")
    .replace(/\b\w/g, (c) => c.toUpperCase())
    .replace(/\bAnd\b/g, "&");
}

function slugifyHeading(text) {
  return String(text || "")
    .toLowerCase()
    .trim()
    .replace(/[’']/g, "")
    .replace(/[^a-z0-9\s-]/g, "")
    .replace(/\s+/g, "-")
    .replace(/-+/g, "-");
}

function estimateReadingTimeFromMarkdown(md) {
  const text = String(md || "")
    .replace(/```[\s\S]*?```/g, " ")
    .replace(/`[^`]*`/g, " ")
    .replace(/[#>*_~]/g, " ");
  const words = text.trim().split(/\s+/).filter(Boolean).length;
  const mins = Math.max(1, Math.round(words / 220));
  return mins;
}

function extractTocFromMarkdown(md) {
  const lines = String(md || "").split("\n");
  const toc = [];
  for (const line of lines) {
    const m = line.match(/^##\s+(.+)\s*$/);
    if (!m) continue;
    const text = m[1].trim();
    const id = slugifyHeading(text);
    toc.push({ text, id });
  }
  return toc;
}

function uniqueAnchorIds(productsList) {
  const seen = new Map();
  return (productsList || []).map((p, idx) => {
    const base = slugifyHeading(p?.title) || `pick-${idx + 1}`;
    const count = seen.get(base) ?? 0;
    seen.set(base, count + 1);
    return count === 0 ? base : `${base}-${count + 1}`;
  });
}

const dateLabel = publishedAt ? formatDate(publishedAt) : "";
const categoryLabel = category ? prettyCategory(category) : "";

const picks = products;

// Normalize hero image value
const heroImageRaw =
  typeof post?.data?.heroImage === "string" && post.data.heroImage.trim().length > 0
    ? post.data.heroImage.trim()
    : FALLBACK_HERO;

const heroAlt =
  typeof post?.data?.heroAlt === "string" && post.data.heroAlt.trim().length > 0
    ? post.data.heroAlt.trim()
    : post?.data?.title ?? "";

const isPublicHero = heroImageRaw.startsWith("/");
const heroAsset = !isPublicHero ? getPostHeroImage(heroImageRaw) : null;

// SEO / sharing
const canonical = `/posts/${post.slug}`;
const ogImage = heroImageRaw;

// Build TOC + reading time from raw markdown body
const rawBody = post.body ?? "";
const toc = extractTocFromMarkdown(rawBody);
const readingTime = estimateReadingTimeFromMarkdown(rawBody);

// Quick picks behavior
const MAX_QUICK_PICKS = 8;
const anchorIds = uniqueAnchorIds(picks);
const quickPicks = picks.slice(0, MAX_QUICK_PICKS);
const quickIds = anchorIds.slice(0, MAX_QUICK_PICKS);
---

<SiteLayout
  title={post.data.title}
  description={post.data.description}
  canonical={canonical}
  ogImage={ogImage}
>
  <PostLayout
    title={post.data.title}
    description={post.data.description}
    publishedAt={publishedAt}
    category={category}
    audience={post.data.audience}
    heroImage={heroImageRaw}
    heroAlt={heroAlt}
    imageCreditName={post.data.imageCreditName}
    imageCreditUrl={post.data.imageCreditUrl}
    readingTime={readingTime}
    toc={toc}
  >
    <Content />

    <hr />

    <section id="top-picks" class="picks-block">
      <h2>Picks</h2>
      <p class="picks-sub">A practical short-list with direct links.</p>

      <div class="picks-list">
        {picks.map((p, idx) => {
          const id = anchorIds[idx];
          return (
            <div id={id} class="pick-anchor" data-pick>
              <ProductListItem product={p} index={idx + 1} />
            </div>
          );
        })}
      </div>
    </section>

    <Fragment slot="sidebar">
      <div class="side-stack">
        <div class="sidecard-lite">
          <div class="side-title">Quick picks</div>

          <ol class="quick-list" aria-label="Quick picks list">
            {quickPicks.map((p, idx) => {
              const id = quickIds[idx];
              return (
                <li class="quick-item">
                  <a href={`#${id}`} class="quick-link" title={p.title}>
                    <span class="quick-num">{idx + 1}.</span>
                    <span class="quick-title">{p.title}</span>
                  </a>

                  {(typeof p.rating === "number" || typeof p.reviews_count === "number") && (
                    <div class="quick-meta">
                      {typeof p.rating === "number" ? <span>{p.rating.toFixed(1)}★</span> : null}
                      {typeof p.reviews_count === "number" ? (
                        <span>
                          {typeof p.rating === "number" ? " · " : ""}
                          {p.reviews_count.toLocaleString()} reviews
                        </span>
                      ) : null}
                    </div>
                  )}
                </li>
              );
            })}
          </ol>

          {picks.length > MAX_QUICK_PICKS ? (
            <p class="quick-more">
              Showing {MAX_QUICK_PICKS} of {picks.length}. Jump into the list for the rest.
            </p>
          ) : null}

          <a href="#top-picks" class="jump-link">Jump to list →</a>
        </div>

        <div class="sidecard-lite sidecard-toc">
          <div class="side-title">On this page</div>
          {Array.isArray(toc) && toc.length ? (
            <nav class="toc">
              <ol class="toc-list">
                {toc.map((item) => (
                  <li class="toc-item">
                    <a class="toc-link" href={`#${item.id}`}>
                      {item.text}
                    </a>
                  </li>
                ))}
              </ol>
            </nav>
          ) : (
            <p class="toc-empty">No table of contents is available for this page.</p>
          )}
        </div>
      </div>
    </Fragment>

    <style>
      .picks-block {
        margin-top: 28px;
      }
      .picks-sub {
        margin-top: 8px;
        color: rgba(55, 65, 81, 0.85);
        font-size: 14px;
        line-height: 1.55;
      }
      .picks-list {
        margin-top: 18px;
        display: grid;
        gap: 18px;
      }
      .pick-anchor {
        scroll-margin-top: 90px;
        border-radius: 18px;
      }

      /* ✅ :target highlight for the selected pick */
      .pick-anchor:target {
        outline: 2px solid rgba(37, 99, 235, 0.35);
        outline-offset: 6px;
        background: rgba(37, 99, 235, 0.03);
      }

      .side-stack {
        display: grid;
        gap: 12px;
      }

      .sidecard-lite {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(17, 24, 39, 0.08);
        border-radius: 18px;
        padding: 16px;
      }

      .side-title {
        font-size: 13px;
        font-weight: 800;
        color: rgba(17, 24, 39, 0.9);
        letter-spacing: -0.01em;
      }

      .quick-list {
        margin: 12px 0 0;
        padding: 0;
        list-style: none;
        display: grid;
        gap: 10px;
        font-size: 13px;
        max-height: 360px;
        overflow: auto;
        padding-right: 6px;
        scrollbar-gutter: stable;
      }

      .quick-list::-webkit-scrollbar {
        width: 10px;
      }
      .quick-list::-webkit-scrollbar-thumb {
        background: rgba(17, 24, 39, 0.12);
        border-radius: 999px;
        border: 3px solid rgba(255, 255, 255, 0.95);
      }
      .quick-list::-webkit-scrollbar-track {
        background: transparent;
      }

      .quick-item {
        padding: 10px 10px;
        border-radius: 14px;
        border: 1px solid rgba(17, 24, 39, 0.06);
        background: rgba(17, 24, 39, 0.02);
        transition: background 120ms ease, border-color 120ms ease;
      }

      .quick-link {
        text-decoration: none;
        color: rgba(17, 24, 39, 0.88);
        font-weight: 700;
        line-height: 1.25;
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 6px;
        align-items: baseline;
      }

      .quick-link:hover {
        color: rgb(37, 99, 235);
        text-decoration: underline;
        text-underline-offset: 3px;
      }

      .quick-num {
        color: rgba(55, 65, 81, 0.65);
        font-weight: 800;
      }

      .quick-title {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .quick-meta {
        margin-top: 6px;
        color: rgba(55, 65, 81, 0.7);
        font-size: 12px;
      }

      .quick-more {
        margin: 10px 0 0;
        font-size: 12px;
        line-height: 1.5;
        color: rgba(55, 65, 81, 0.72);
      }

      .jump-link {
        display: inline-block;
        margin-top: 12px;
        font-size: 13px;
        font-weight: 750;
        color: rgb(37, 99, 235);
        text-decoration: none;
      }
      .jump-link:hover {
        text-decoration: underline;
        text-underline-offset: 3px;
      }

      /* ✅ Sidebar “selected” effect: highlight the quick-pick item
         When you click a quick pick, the URL hash becomes #id.
         We can't select "the matching <li>" purely by hash without JS.
         BUT we can give users a very strong cue by:
         - highlighting the *target pick card* (above), and
         - adding a subtle "you are in picks mode" sidebar polish:
      */
      :global(body:has(.pick-anchor:target)) .sidecard-lite {
        border-color: rgba(37, 99, 235, 0.18);
      }

      /* TOC styling */
      .sidecard-toc .toc {
        margin-top: 12px;
      }
      .sidecard-toc .toc-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 8px;
      }
      .sidecard-toc .toc-link {
        font-size: 13px;
        line-height: 1.3;
        color: rgba(17, 24, 39, 0.82);
        text-decoration: none;
      }
      .sidecard-toc .toc-link:hover {
        color: rgb(37, 99, 235);
        text-decoration: underline;
        text-underline-offset: 3px;
      }
      .sidecard-toc .toc-empty {
        margin-top: 10px;
        font-size: 13px;
        color: rgba(55, 65, 81, 0.75);
      }
    </style>
  </PostLayout>
</SiteLayout>
