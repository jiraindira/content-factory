---
import SiteLayout from "../../layouts/SiteLayout.astro";
import GuideCard from "../../components/GuideCard.astro";
import { getCollection } from "astro:content";
import { getTaxonomy } from "../../lib/taxonomy";
import { normalizePostCategories, primaryCategory } from "../../lib/normalizeCategories";

export async function getStaticPaths() {
  const taxonomy = await getTaxonomy();

  // Build routes from taxonomy groups (plus "all")
  const paths = [
    { params: { group: "all" } },
    ...taxonomy.groups.map((g) => ({ params: { group: g.key } })),
  ];

  // De-dupe group keys
  const seen = new Set<string>();
  return paths.filter((p) => {
    const k = String(p.params.group || "").trim().toLowerCase();
    if (!k || seen.has(k)) return false;
    seen.add(k);
    return true;
  });
}

const taxonomy = await getTaxonomy();
const { group } = Astro.params;

const groupKey = String(group || "").trim().toLowerCase();

// Find group (except "all")
const grp =
  groupKey === "all"
    ? { key: "all", label: "All", intro: "", categoryIds: [] as string[] }
    : taxonomy.groups.find((g) => String(g.key || "").trim().toLowerCase() === groupKey);

const label = grp?.label ?? "All";
const intro = grp?.intro ?? "";

// ✅ taxonomy.json uses groups[].categoryIds
const groupCats =
  groupKey === "all"
    ? null
    : (grp?.categoryIds ?? (grp as any)?.categories ?? [])
        .map((c) => String(c || "").trim().toLowerCase())
        .filter(Boolean);

const posts = await getCollection("posts");
posts.sort((a, b) => {
  const t = b.data.publishedAt.getTime() - a.data.publishedAt.getTime();
  if (t !== 0) return t;
  return b.slug.localeCompare(a.slug);
});

// Include if ANY category matches
const filtered =
  groupKey === "all"
    ? posts
    : posts.filter((post) => {
        const postCats = normalizePostCategories(post, taxonomy);
        return postCats.some((c) => (groupCats ?? []).includes(c));
      });

const pageTitle = `${label} guides`;
const pageDesc = intro || `Latest curated buying guides in ${label}.`;
---

<SiteLayout title={pageTitle} description={pageDesc} canonical={`/posts/${groupKey}`}>
  <div class="max-w-6xl mx-auto px-6 pt-12">
    <div class="flex items-end justify-between gap-6">
      <div>
        <h1 class="text-3xl font-semibold tracking-tight text-gray-900">{label}</h1>
        {pageDesc ? <p class="mt-2 text-sm text-gray-600">{pageDesc}</p> : null}
      </div>

      <a href="/posts" class="text-sm font-semibold text-blue-700 hover:text-blue-800">
        View all →
      </a>
    </div>

    <hr class="mt-6 border-t-2 border-gray-900/25" />

    {filtered.length ? (
      <div class="mt-10 grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
        {filtered.map((post) => {
          const cats = normalizePostCategories(post, taxonomy);
          const primary = primaryCategory(post, taxonomy);

          return (
            <GuideCard
              href={`/posts/${post.slug}`}
              title={post.data.title}
              description={post.data.description}
              category={primary}
              categories={cats}
              publishedAt={post.data.publishedAt}
              products={post.data.products}
              heroImage={post.data.heroImageCard ?? post.data.heroImage}
              heroAlt={post.data.heroAlt}
            />
          );
        })}
      </div>
    ) : (
      <div class="mt-10 rounded-2xl border border-dashed border-gray-300 bg-white p-10">
        <p class="text-sm text-gray-600">No guides in this section yet.</p>
      </div>
    )}
  </div>
</SiteLayout>
